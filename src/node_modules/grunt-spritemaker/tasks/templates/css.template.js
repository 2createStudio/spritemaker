'use strict';

/**
 * Dependencies
 */
var fs       = require('fs');
var mustache = require('mustache');

/**
 * Converts the json to css.
 * @param  {object} params 
 * @return {string}        
 */
function cssTemplate(params) {

    var items   = params.items;
    var options = params.options;
    var details = {}; 
    var file    = '/css.mustache';
    var tpl     = fs.readFileSync(__dirname + '' + file, 'utf8');

    // fallback class naming function
    var classFn = options.cssClass || function(item) {
        return '.sprite-' + item.name;
    }

    // add class property
    items.forEach(function(item) {
        item['class']       = classFn(item);
        item.escaped_image  = item.escaped_image.replace('/', '');
    });

    // get details for sprite
    if (items.length) {
        var item = items[0];

        details.prefix            = item['class'].replace(item.name, '').replace('.', '');
        details.escaped_image     = item.escaped_image;
        details.total_width       = item.total_width;
        details.total_height      = item.total_height;
        details.half_total_width  = item.total_width/2;
        details.half_total_height = item.total_height/2;
        details.hd_path           = item.escaped_image.replace(/(-.*\.)/, '-' + options.hdPrefix + '.');
        details.is_retina         = options.hdPrefix !== undefined;
    }

    params.details = details;

    // render and return css
    return mustache.render(tpl, params);

}

/**
 * Publish
 */
module.exports = cssTemplate;